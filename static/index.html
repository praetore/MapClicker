<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Google Maps Clicker</title>
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <!-- Include Google Maps JS API -->
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDstP10zYrVkV0gWORTQITPLycxuxIKUeE&sensor=false">
    </script>
    <style type="text/css">
        body {
            font-family: Arial, sans-serif;
        }

        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        p#num {
            float: left;
            margin: 10px;
        }
    </style>
    <!-- Map creation is here -->
    <script type="text/javascript">
        // Defining global variables to access from other functions
        var map, num;
        var circles = [],
                points = [],
                files = [];

        $.ajax({
            url: 'api/datapoints',
            type: 'GET',
            success: function (data) {
                points = data.objects;
                num = data.num_results;
            }
        });

        $.ajax({
            url: 'api/schematics',
            type: 'GET',
            success: function (data) {
                files = data.objects;
            }
        });

        function initMap() {
            // Enabling new cartography and themes
            google.maps.visualRefresh = true;
            // Setting starting options of map
            var mapOptions = {
                center: new google.maps.LatLng(51.958581, 4.024580),
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.SATELLITE,
                streetViewControl: false
            };

            // Getting map DOM element
            var mapElement = document.getElementById('map');

            // Creating a map with DOM element which is just obtained
            map = new google.maps.Map(mapElement, mapOptions);

            toggleRemoveButtonDisplay(num);
            toggleInfoDisplay(num);
            toggleExportButtonDisplay(num);

            // display options of schematicfiles to add to geo-point
            for (var i = 0; i < files.length; i++) {
                var option = $('<option></option>')
                        .attr("value", files[i].type)
                        .text(files[i].type);
                $('select#schematic').append(option);
            }

            for (var i = 0; i < points.length; i++) {
                var point = points[i];
                addCircle(point);
            }

            // add map listener to index get geo-points
            google.maps.event.addListener(map, 'click', function (e) {
                var lat = e.latLng.lat();
                var lng = e.latLng.lng();
                var type = $('#schematic').val();

                addPoint(lat, lng, type);
                num++;
                toggleRemoveButtonDisplay(num);
                toggleInfoDisplay(num);
                toggleExportButtonDisplay(num);
            });

            // add a listener to remove last geo-point from database
            $('button#remove').click(function () {
                deletePoint(num);
                num--;
                toggleRemoveButtonDisplay(num);
                toggleInfoDisplay(num);
                toggleExportButtonDisplay(num);
            });

            // add a listener to export all indexed geo-points to csv
            $('button#export').click(function () {
                location.href = '/export'
            })
        }
        google.maps.event.addDomListener(window, 'load', initMap);

        // add a geo-point to database
        var addPoint = function (lat, long, type) {
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: 'api/datapoints',
                type: 'POST',
                data: JSON.stringify({
                    "lat": lat,
                    "long": long,
                    "type": type
                }),
                success: function (data) {
                    addCircle(data);
                }
            });
        };

        // add a circle to the map
        var addCircle = function (point) {
            var color;
            var radius;
            for (var i = 0; i < files.length; i++) {
                var option = files[i];
                if (option.type == point.type) {
                    color = option.color;
                    radius = parseInt(option.radius);
                }
            }

            // Defining options for circle
            var options = {
                strokeColor: color,
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: color,
                fillOpacity: 0.35,
                map: map,
                radius: radius,
                center: new google.maps.LatLng(point.lat, point.long)
            };

            // Add point to map
            var circle = new google.maps.Circle(options);
            circles.push(circle);
        };

        // delete a geo-point from the database
        var deletePoint = function (idx) {
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: 'api/datapoints/' + idx,
                type: 'DELETE',
                success: function () {
                    var circle = circles.pop();
                    circle.setMap(null);
                }
            });
        };

        // toggle the display of the remove button
        var toggleRemoveButtonDisplay = function (num) {
            var elem = $('button#remove');
            if (num > 0) {
                elem.show();
            } else {
                elem.hide();
            }
        };

        // toggle the display of the remove button
        var toggleExportButtonDisplay = function (num) {
            var elem = $('button#export');
            if (num > 0) {
                elem.show();
            } else {
                elem.hide();
            }
        };

        // toggle the display of number of indexed geo-points
        var toggleInfoDisplay = function (num) {
            var elem = $('p#num');
            if (num > 0) {
                elem.show();
            } else {
                elem.hide();
            }
            elem.html(num + ' coordinaten geindexeerd');
        };
    </script>
</head>
<body>
<div id="selectSchematic">
    <select name="schematic" id="schematic"></select>
    <button id="export">Exporteren naar csv</button>
    <button id="remove">Laatste punt verwijderen</button>
    <p id="num"></p>
</div>
<div id="map"></div>
</body>
</html>