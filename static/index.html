<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>Google Maps Clicker</title>
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <!-- Include Google Maps JS API -->
    <script type="text/javascript"
            src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDstP10zYrVkV0gWORTQITPLycxuxIKUeE&sensor=false">
    </script>
    <style type="text/css">
        body {
            font-family: Arial, sans-serif;
        }
        html {
            height: 100%
        }
        body {
            height: 100%;
            margin: 0;
        }
        #mapDiv {
            width: 100%;
            height: 100%;
        }
        #num {
            float: left;
            margin: 10px;
        }
    </style>
    <!-- Map creation is here -->
    <script type="text/javascript">
        var infowindow = null;
        //Defining map as a global variable to access from
        //other functions
        var lat, lng, map;
        var num = 0;

        $.ajax({
            url: 'api/datapoints',
            type: 'GET',
            success: function (data) {
                num = data.num_results;
            }
        });

        $('#num').html(num + ' coordinaten geindexeerd');

        function initMap() {
            //Enabling new cartography and themes
            google.maps.visualRefresh = true;
            //Setting starting options of map
            var mapOptions = {
                center: new google.maps.LatLng(51.958581, 4.024580),
                zoom: 13,
                mapTypeId: google.maps.MapTypeId.ROADMAP
            };
            //Getting map DOM element
            var mapElement = document.getElementById('mapDiv');
            //Creating a map with DOM element which is just obtained
            map = new google.maps.Map(mapElement, mapOptions);

            toggleButtonDisplay(num);
            toggleInfoDisplay(num);

            google.maps.event.addListener(map, 'click', function (e) {
                lat = e.latLng.lat();
                lng = e.latLng.lng();

                addPoint(lat, lng);
                num++;
                toggleButtonDisplay(num);
                toggleInfoDisplay(num);
            });

            $('button#remove').click(function () {
                deleteLastPoint(num);
                num--;
                toggleButtonDisplay(num);
                toggleInfoDisplay(num);
            });

            $('button#export').click(function () {
                location.href = '/export'
            })
        }
        google.maps.event.addDomListener(window, 'load', initMap);

        var addPoint = function (lat, long) {
            var schematic = $('#schematic').val();
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: 'api/datapoints',
                type: 'POST',
                data: JSON.stringify({
                    "lat": lat,
                    "long": long,
                    "schematic": schematic
                })
            });
        };

        var deleteLastPoint = function (idx) {
            $.ajax({
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                url: 'api/datapoints/' + idx,
                type: 'DELETE'
            });
        };

        var toggleButtonDisplay = function (num) {
            if (num == 0) {
                $('button#remove').hide();
            } else {
                $('button#remove').show();
            }
        };

        var toggleInfoDisplay = function (num) {
            if (num > 0) {
                $('p#num').show();
            } else {
                $('p#num').hide();
            }
            $('p#num').html(num + ' coordinaten geindexeerd');
        };
    </script>
</head>
<body>
<div id="selectSchematic">
    <button id="export">Exporteren naar csv</button>
    <select name="schematic" id="schematic">
        <option value="pointytower.schematic">Silo</option>
        <option value="Gebouw 2">Gebouw 2</option>
        <option value="Gebouw 3">Gebouw 3</option>
        <option value="Gebouw 4">Gebouw 4</option>
        <option value="Gebouw 5">Gebouw 5</option>
    </select>
    <p id="num"></p>
    <button id="remove">Laatste punt verwijderen</button>
</div>
<div id="mapDiv"></div>
</body>
</html>